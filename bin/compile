#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

export CWD=$(cd $(dirname $0)/; pwd)
export APP_DIR=/app

# parse args
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

export BIN_DIR=$BUILD_DIR/.bin

mkdir -p $BIN_DIR

mv $CWD/* $BIN_DIR/

. $BIN_DIR/util/common.sh

LOG_FILE='/tmp/commandbox-build-log.txt'

export_env_dir $ENV_DIR

JVM_COMMON_BUILDPACK=${JVM_COMMON_BUILDPACK:-https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz}
mkdir -p /tmp/jvm-common
curl --retry 3 --silent --location $JVM_COMMON_BUILDPACK | tar xzm -C /tmp/jvm-common --strip-components=1
. /tmp/jvm-common/bin/util
. /tmp/jvm-common/bin/java
. /tmp/jvm-common/opt/jdbc.sh
install_java_with_overlay ${BUILD_DIR}


# fail hard from this point on
set -o pipefail
# fail harder
set -eu

mkdir -p $CACHE_DIR

# Make sure permissions are in place on all of our scripts
chmod + $BIN_DIR/util/*.sh
chmod +x $BIN_DIR/run/*.sh

status "Installing CommandBox"

export PATH=$PATH:$BIN_DIR

#Set our commandbox home directory
touch $BIN_DIR/commandbox.properties
chmod +rw $BIN_DIR/commandbox.properties
echo "commandbox_home=$BIN_DIR/.CommandBox" > $BIN_DIR/commandbox.properties

$BIN_DIR/util/install-commandbox.sh

# install CFConfig modules
status "Installing CFConfig module"
box install commandbox-cfconfig
status "CFConfig module successfully installed"

#Install JQ
curl -L http://stedolan.github.io/jq/download/linux64/jq > $BIN_DIR/jq
chmod +x $BIN_DIR/jq

# Change our Commandbox home to the runtime
echo "commandbox_home=/app/.bin/.CommandBox" > $BIN_DIR/commandbox.properties

# Create our environment variables
mkdir -p $BUILD_DIR/.profile.d
touch $BUILD_DIR/.profile.d/defaults.sh
chmod +x $BUILD_DIR/.profile.d/defaults.sh

echo "export PATH=$PATH:/app/.bin" >> $BUILD_DIR/.profile.d/defaults.sh
echo "export APP_DIR=/app" >> $BUILD_DIR/.profile.d/defaults.sh
echo "export BUILD_DIR=/app" >> $BUILD_DIR/.profile.d/defaults.sh
echo "export BIN_DIR=/app/.bin" >> $BUILD_DIR/.profile.d/defaults.sh

status "Commandbox Heroku Image Compilation Complete"
